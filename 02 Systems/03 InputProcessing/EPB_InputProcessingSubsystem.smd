use functionset EPB_InputProcessingSubsystem_Functions
use requirementset EPB_InputProcessingSubsystem_Requirements
use block EPB_InputProcessingSubsystem
use configset ElectricParkingBrakeFeaturesVariants_BMWConfig

hdef statemachine EPB_InputProcessingStateMachine
  name "EPB Input Processing Subsystem State Machine"
  description """
    Complete state machine controlling EPB input processing operations including initialization,
    active processing, fault handling, and diagnostic modes with full ISO 26262 ASIL-D compliance.
    """
  owner "Input Processing Systems Team"
  tags "input-processing", "state-machine", "safety-critical", "iso26262"
  safetylevel ASIL-D
  status approved
  allocatedto ref block EPB_InputProcessingSubsystem
  implements ref requirement REQ_IP_001

  def state Uninitialized
    name "Uninitialized State"
    description "Input processing subsystem in uninitialized state, waiting for system startup"
    owner "System Initialization Team"
    tags "uninitialized", "startup", "initial"
    status implemented
    initialstate true
    implements ref requirement REQ_IP_001_1
    when ref config c_BasicEPBFeatures

  def state Initializing
    name "Initializing State"
    description "Input processing subsystem performing initialization and self-diagnostics"
    owner "Initialization Team"
    tags "initializing", "self-test", "startup"
    status implemented
    implements ref requirement REQ_IP_002
    when ref config c_FailureDiagnostics

  def state Active
    name "Active Processing State"
    description "Input processing subsystem actively processing all input signals and operations"
    owner "Processing Team"
    tags "active", "processing", "operational"
    status implemented
    implements ref requirement REQ_IP_003

  def state Degraded
    name "Degraded Processing State"
    description "Input processing subsystem operating with reduced functionality due to sensor faults"
    owner "Fault Tolerance Team"
    tags "degraded", "partial-function", "fault-tolerance"
    status implemented
    implements ref requirement REQ_IP_004
    when ref config c_FailureDiagnostics

  def state Diagnostic
    name "Diagnostic Mode State"
    description "Input processing subsystem in diagnostic mode for maintenance and testing"
    owner "Diagnostic Team"
    tags "diagnostic", "maintenance", "testing"
    status implemented
    implements ref requirement REQ_IP_005
    when ref config c_ECUDiagnostics

  def state Fault
    name "Fault State"
    description "Input processing subsystem in fault condition requiring immediate attention"
    owner "Safety Team"
    tags "fault", "safety-critical", "emergency"
    status implemented
    endstate true
    implements ref requirement REQ_IP_006
    when ref config c_FailureDiagnostics

  def transition SystemStartup
    name "System Startup Transition"
    description "Transition from uninitialized to initializing when system power-up detected"
    owner "Initialization Team"
    tags "startup", "power-up", "initialization"
    status implemented
    from ref state Uninitialized
    to ref state Initializing
    condition "power_supply_stable AND system_clock_active AND configuration_loaded"
    call ref function InitializeChairSystem
    implements ref requirement REQ_IP_007
    when ref config c_BasicEPBFeatures

  def transition InitializationComplete
    name "Initialization Complete Transition"
    description "Transition from initializing to active when all self-tests pass successfully"
    owner "Initialization Team"
    tags "initialization-complete", "self-test-pass", "active"
    status implemented
    from ref state Initializing
    to ref state Active
    condition "self_diagnostics_passed AND all_sensors_calibrated AND communication_established"
    call ref function VehicleStateValidator
    implements ref requirement REQ_IP_008

  def transition InitializationFailed
    name "Initialization Failed Transition"
    description "Transition from initializing to fault when initialization or self-tests fail"
    owner "Safety Team"
    tags "initialization-failed", "self-test-fail", "fault"
    status implemented
    from ref state Initializing
    to ref state Fault
    condition "self_diagnostics_failed OR sensor_calibration_failed OR communication_timeout"
    call ref function FaultDetector
    implements ref requirement REQ_IP_009
    when ref config c_FailureDiagnostics

  def transition SensorDegradation
    name "Sensor Degradation Transition"
    description "Transition from active to degraded when sensor faults detected but system can continue"
    owner "Fault Management Team"
    tags "sensor-degradation", "partial-fault", "degraded-mode"
    status implemented
    from ref state Active
    to ref state Degraded
    condition "sensor_fault_detected AND redundant_sensors_available AND safety_criteria_met"
    call ref function PlausibilityChecker
    implements ref requirement REQ_IP_010
    when ref config c_FailureDiagnostics

  def transition CriticalFaultDetected
    name "Critical Fault Detection Transition"
    description "Transition from active to fault when critical safety fault detected"
    owner "Safety Team"
    tags "critical-fault", "safety-violation", "emergency"
    status implemented
    from ref state Active
    to ref state Fault
    condition "critical_sensor_failure OR communication_loss OR safety_violation_detected"
    call ref function FaultDetector
    implements ref requirement REQ_IP_011
    when ref config c_FailureDiagnostics

  def transition DegradedToFault
    name "Degraded to Fault Transition"
    description "Transition from degraded to fault when additional failures compromise safety"
    owner "Safety Team"
    tags "degraded-fault", "multiple-failures", "safety-critical"
    status implemented
    from ref state Degraded
    to ref state Fault
    condition "additional_sensor_failure OR safety_threshold_exceeded OR timeout_exceeded"
    call ref function FaultDetector
    implements ref requirement REQ_IP_012
    when ref config c_FailureDiagnostics

  def transition EnterDiagnostic
    name "Enter Diagnostic Mode Transition"
    description "Transition from active to diagnostic mode for maintenance operations"
    owner "Maintenance Team"
    tags "diagnostic-entry", "maintenance", "service-mode"
    status implemented
    from ref state Active
    to ref state Diagnostic
    condition "diagnostic_mode_requested AND vehicle_stationary AND service_tool_connected"
    call ref function PerformSafetyDiagnostics
    implements ref requirement REQ_IP_013
    when ref config c_ECUDiagnostics

  def transition ExitDiagnostic
    name "Exit Diagnostic Mode Transition"
    description "Transition from diagnostic mode back to active processing"
    owner "Maintenance Team"
    tags "diagnostic-exit", "return-to-service", "operational"
    status implemented
    from ref state Diagnostic
    to ref state Active
    condition "diagnostic_complete AND all_tests_passed AND service_tool_disconnected"
    call ref function VehicleStateValidator
    implements ref requirement REQ_IP_014
    when ref config c_ECUDiagnostics

  def transition DiagnosticFault
    name "Diagnostic Fault Transition"
    description "Transition from diagnostic to fault when diagnostic tests reveal critical issues"
    owner "Diagnostic Team"
    tags "diagnostic-fault", "test-failure", "maintenance-fault"
    status implemented
    from ref state Diagnostic
    to ref state Fault
    condition "diagnostic_test_failed OR hardware_fault_detected OR calibration_error"
    call ref function FaultDetector
    implements ref requirement REQ_IP_015
    when ref config c_ECUDiagnostics

  def transition SystemRecovery
    name "System Recovery Transition"
    description "Transition from degraded back to active when sensor faults are resolved"
    owner "Recovery Team"
    tags "system-recovery", "fault-cleared", "restoration"
    status implemented
    from ref state Degraded
    to ref state Active
    condition "sensor_faults_cleared AND all_sensors_operational AND safety_validation_passed"
    call ref function VehicleStateValidator
    implements ref requirement REQ_IP_016
    when ref config c_FailureDiagnostics

hdef statemachine EPB_InputProcessingSubsystemStateMachine
  name "EPB Input Processing Subsystem State Machine"
  description "Complete state machine for EPB Input Processing Subsystem controlling signal validation, processing, fault detection, and output generation with ISO 26262 ASIL-D compliance. Manages transitions between initialization, normal operation, fault conditions, and diagnostic modes."
  owner "Input Processing Systems Team"
  tags "input-processing", "state-machine", "signal-validation", "iso26262", "ASIL-D"
  safetylevel ASIL-D
  status approved
  allocatedto ref block EPB_InputProcessingSubsystem
  implements ref function VehicleStateValidator

  def state Initialization
    name "System Initialization State"
    description "Input processing subsystem initializing all signal validators, processors, and diagnostic functions. Performing self-tests, calibration validation, and establishing baseline signal states."
    owner "Input Processing Team"
    tags "initialization", "self-test", "calibration", "startup"
    status implemented
    initialstate true
    implements ref function VehicleStateValidator
    when ref config c_ComfortFeatures_ECUDiagnostics

  def state SignalAcquisition
    name "Signal Acquisition State"
    description """
      Actively acquiring and buffering input signals from vehicle systems, driver interfaces, 
      and actuator feedback. Performing initial range checks and signal quality validation.
      """
    owner "Signal Processing Team"
    tags "acquisition", "buffering", "range-check", "signal-quality"
    status implemented
    implements ref requirement REQ_INPUT_002
    when ref config c_FailureDiagnostics

  def state SignalValidation
    name "Signal Validation State"
    description """
      Comprehensive validation of acquired signals including plausibility checks, 
      cross-validation between redundant channels, and fault detection algorithms.
      """
    owner "Validation Team"
    tags "validation", "plausibility", "cross-validation", "fault-detection"
    status implemented
    implements ref requirement REQ_INPUT_001_1
    when ref config c_SecondarySensorTechnology

  def state SignalProcessing
    name "Signal Processing State"
    description """
      Processing validated signals through filtering, conditioning, calibration, and 
      conversion to internal formats for EPB control system consumption.
      """
    owner "Signal Processing Team"
    tags "processing", "filtering", "conditioning", "calibration"
    status implemented
    implements ref requirement REQ_INPUT_003
    when ref config c_SlopeCompensation

  def state OutputGeneration
    name "Output Generation State"
    description """
      Generating processed output messages and signals for internal EPB subsystems
      with timestamp validation and integrity checking.
      """
    owner "Output Generation Team"
    tags "output-generation", "messaging", "timestamp", "integrity"
    status implemented
    implements ref requirement REQ_INPUT_004

  def state FaultDetected
    name "Fault Detection State"
    description """
      Input processing subsystem detected fault condition requiring diagnostic attention.
      Implementing fault isolation, fallback signal generation, and error reporting.
      """
    owner "Diagnostics Team"
    tags "fault", "diagnostic", "isolation", "fallback"
    status implemented
    implements ref requirement REQ_INPUT_FAULT_001
    when ref config c_FailureDiagnostics

  def state DiagnosticMode
    name "Diagnostic Mode State"
    description """
      Special diagnostic mode for calibration, testing, and maintenance operations
      with enhanced monitoring and data logging capabilities.
      """
    owner "Service Team"
    tags "diagnostic", "calibration", "testing", "maintenance"
    status implemented
    implements ref requirement REQ_INPUT_DIAG_001
    when ref config c_ECUDiagnostics

  def state SafeMode
    name "Safe Mode State"
    description """
      Safe operation mode with minimal signal processing using validated fallback values
      and conservative assumptions for continued operation during fault conditions.
      """
    owner "Safety Team"
    tags "safe-mode", "fallback", "conservative", "fault-tolerance"
    status implemented
    endstate true
    implements ref requirement REQ_INPUT_SAFE_001

  def transition InitializationComplete
    name "Initialization Complete Transition"
    description "Transition from initialization to signal acquisition when all self-tests pass and system is ready"
    owner "Input Processing Team"
    tags "initialization-complete", "self-test-pass", "ready"
    status implemented
    from ref state Initialization
    to ref state SignalAcquisition
    condition "self_tests_passed AND calibration_valid AND signal_sources_available AND system_healthy"
    calls ref function InitializeSignalProcessors
    implements ref requirement REQ_INPUT_INIT_COMPLETE_001
    when ref config c_ECUDiagnostics

  def transition SignalsAcquired
    name "Signals Acquired Transition"
    description "Transition from acquisition to validation when sufficient signal samples are buffered"
    owner "Signal Processing Team"
    tags "signals-acquired", "buffering-complete", "validation-ready"
    status implemented
    from ref state SignalAcquisition
    to ref state SignalValidation
    condition "signal_buffers_filled AND sample_rate_adequate AND signal_integrity_ok"
    calls ref function PrepareValidation
    implements ref requirement REQ_INPUT_ACQUIRE_COMPLETE_001

  def transition ValidationComplete
    name "Validation Complete Transition"
    description "Transition from validation to processing when all signals pass validation checks"
    owner "Validation Team"
    tags "validation-complete", "signals-valid", "processing-ready"
    status implemented
    from ref state SignalValidation
    to ref state SignalProcessing
    condition "plausibility_checks_passed AND cross_validation_ok AND fault_flags_clear"
    calls ref function StartSignalProcessing
    implements ref requirement REQ_INPUT_VALIDATION_COMPLETE_001
    when ref config c_SecondarySensorTechnology

  def transition ProcessingComplete
    name "Processing Complete Transition"
    description "Transition from processing to output generation when signal conditioning is complete"
    owner "Signal Processing Team"
    tags "processing-complete", "conditioning-done", "output-ready"
    status implemented
    from ref state SignalProcessing
    to ref state OutputGeneration
    condition "filtering_complete AND calibration_applied AND format_conversion_done"
    call ref function GenerateOutputs
    implements ref requirement REQ_INPUT_PROCESSING_COMPLETE_001

  def transition OutputGenerated
    name "Output Generated Transition"
    description "Transition back to acquisition for next processing cycle when outputs are generated"
    owner "Output Generation Team"
    tags "output-generated", "cycle-complete", "next-cycle"
    status implemented
    from ref state OutputGeneration
    to ref state SignalAcquisition
    condition "outputs_published AND integrity_verified AND next_cycle_ready"
    calls ref function StartNextCycle
    implements ref requirement REQ_INPUT_OUTPUT_COMPLETE_001

  def transition FaultFromAcquisition
    name "Fault From Acquisition Transition"
    description "Emergency transition to fault state when signal acquisition failures detected"
    owner "Diagnostics Team"
    tags "acquisition-fault", "signal-loss", "emergency"
    status implemented
    from ref state SignalAcquisition
    to ref state FaultDetected
    condition "signal_timeout OR signal_out_of_range OR acquisition_hardware_failure"
    calls ref function HandleAcquisitionFault
    implements ref requirement REQ_INPUT_FAULT_ACQUISITION_001
    when ref config c_FailureDiagnostics

  def transition FaultFromValidation
    name "Fault From Validation Transition"
    description "Emergency transition to fault state when validation failures detected"
    owner "Diagnostics Team"
    tags "validation-fault", "plausibility-failure", "cross-check-failure"
    status implemented
    from ref state SignalValidation
    to ref state FaultDetected
    condition "plausibility_failure OR cross_validation_mismatch OR redundancy_loss"
    calls ref function HandleValidationFault
    implements ref requirement REQ_INPUT_FAULT_VALIDATION_001
    when ref config c_SecondarySensorTechnology

  def transition FaultFromProcessing
    name "Fault From Processing Transition"
    description "Emergency transition to fault state when processing failures detected"
    owner "Diagnostics Team"
    tags "processing-fault", "algorithm-failure", "computation-error"
    status implemented
    from ref state SignalProcessing
    to ref state FaultDetected
    condition "processing_algorithm_failure OR computation_overflow OR calibration_error"
    calls ref function HandleProcessingFault
    implements ref requirement REQ_INPUT_FAULT_PROCESSING_001

  def transition DiagnosticEntry
    name "Diagnostic Entry Transition"
    description "Transition to diagnostic mode when diagnostic request received"
    owner "Service Team"
    tags "diagnostic-entry", "service-request", "maintenance"
    status implemented
    from ref state SignalAcquisition
    to ref state DiagnosticMode
    condition "diagnostic_request_received AND service_mode_authorized AND system_idle"
    calls ref function EnterDiagnosticMode
    implements ref requirement REQ_INPUT_DIAGNOSTIC_ENTRY_001
    when ref config c_ECUDiagnostics

  def transition DiagnosticExit
    name "Diagnostic Exit Transition"
    description "Transition from diagnostic mode back to normal operation"
    owner "Service Team"
    tags "diagnostic-exit", "service-complete", "normal-operation"
    status implemented
    from ref state DiagnosticMode
    to ref state SignalAcquisition
    condition "diagnostic_complete AND calibration_updated AND service_authorized_exit"
    calls ref function ExitDiagnosticMode
    implements ref requirement REQ_INPUT_DIAGNOSTIC_EXIT_001

  def transition SafeModeEntry
    name "Safe Mode Entry Transition"
    description "Critical transition to safe mode when multiple faults compromise system integrity"
    owner "Safety Team"
    tags "safe-mode-entry", "critical-fault", "system-compromise"
    status implemented
    from ref state FaultDetected
    to ref state SafeMode
    condition "multiple_faults_detected OR safety_critical_failure OR fault_isolation_failed"
    calls ref function EnterSafeMode
    implements ref requirement REQ_INPUT_SAFE_ENTRY_001

  def transition FaultRecovery
    name "Fault Recovery Transition"
    description "Transition from fault state back to acquisition when fault conditions are resolved"
    owner "Diagnostics Team"
    tags "fault-recovery", "fault-clear", "system-restore"
    status implemented
    from ref state FaultDetected
    to ref state SignalAcquisition
    condition "fault_conditions_cleared AND recovery_validation_passed AND system_integrity_restored"
    calls ref function RecoverFromFault
    implements ref requirement REQ_INPUT_FAULT_RECOVERY_001
    when ref config c_FailureDiagnostics

  def transition InitializationFailure
    name "Initialization Failure Transition"
    description "Transition from initialization to safe mode when critical initialization failures occur"
    owner "Safety Team"
    tags "initialization-failure", "startup-fault", "critical-failure"
    status implemented
    from ref state Initialization
    to ref state SafeMode
    condition "self_test_failure OR calibration_invalid OR critical_hardware_failure"
    calls ref function HandleInitializationFailure
    implements ref requirement REQ_INPUT_INIT_FAILURE_001
    when ref config c_ECUDiagnostics
